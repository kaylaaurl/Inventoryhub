<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InventoryHub Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen font-sans">
  <div class="flex">
    <aside class="w-64 bg-white/70 backdrop-blur-md shadow-lg rounded-r-3xl p-6 flex flex-col space-y-4">
      <h1 class="text-2xl font-bold text-blue-600 mb-4">📊 InventoryHub</h1>
      <nav class="space-y-2">
        <a href="/" class="flex items-center px-4 py-2 rounded-lg text-blue-700 {{ 'bg-blue-100 font-medium' if current_page == 'dashboard' else 'hover:bg-blue-100' }}">📈 Dashboard</a>
        <a href="/user" class="flex items-center px-4 py-2 rounded-lg text-blue-700 {{ 'bg-blue-100 font-medium' if current_page == 'user' else 'hover:bg-blue-100' }}">👤 Kelola User</a>
        <a href="/inventory" class="flex items-center px-4 py-2 rounded-lg text-blue-700 {{ 'bg-blue-100 font-medium' if current_page == 'inventory' else 'hover:bg-blue-100' }}">📦 Kelola Inventaris</a>
        <a href="/category" class="flex items-center px-4 py-2 rounded-lg text-blue-700 {{ 'bg-blue-100 font-medium' if current_page == 'category' else 'hover:bg-blue-100' }}">🗂️ Kelola Kategori</a>
        <a href="/supplier" class="flex items-center px-4 py-2 rounded-lg text-blue-700 {{ 'bg-blue-100 font-medium' if current_page == 'supplier' else 'hover:bg-blue-100' }}">🚚 Kelola Supplier</a>
        <a href="/notification" class="flex items-center px-4 py-2 rounded-lg text-blue-700 {{ 'bg-blue-100 font-medium' if current_page == 'notification' else 'hover:bg-blue-100' }}">🔔 Kelola Notifikasi</a>
      </nav>
    </aside>

    <main class="flex-1 p-8 space-y-6">
      <div class="grid grid-cols-5 gap-4" id="stats-cards"></div>
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-blue-600 font-semibold mb-4">Statistik User & Inventaris</h2>
        <canvas id="barChart" height="100"></canvas>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div class="col-span-2 bg-white rounded-xl shadow-md p-6">
          <h2 class="text-blue-600 font-semibold mb-4">Distribusi Kategori</h2>
          <canvas id="pieChart" height="150"></canvas>
        </div>
        <div class="flex flex-col space-y-4">
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-blue-600 font-semibold mb-2">💡 Tips Penggunaan</h3>
            <ul class="text-sm text-gray-600 list-disc list-inside">
              <li>Gunakan menu sidebar</li>
              <li>Perbarui data rutin</li>
              <li>Manfaatkan fitur notifikasi</li>
            </ul>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-blue-600 font-semibold mb-2">🕒 Aktivitas Terakhir</h3>
            <ul class="text-sm text-gray-600 list-disc list-inside" id="recent-activity">
              <li>Memuat aktivitas...</li>
            </ul>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-blue-600 font-semibold mb-2">ℹ️ Quick Info</h3>
            <p class="text-sm text-gray-500" id="quick-info">Dashboard InventoryHub siap membantu Anda!</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    async function fetchCountGraphQL(url, query, key) {
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        const json = await res.json();
        return json.data[key]?.length || 0;
      } catch { return 0; }
    }

    async function fetchUserCount() {
      try {
        const res = await fetch('/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: '{ getUsers { id } }' })
        });
        const json = await res.json();
        return json.data.getUsers?.length || 0;
      } catch { return 0; }
    }

    async function fetchRecentActivity() {
      try {
        const res = await fetch('/notification');
        const data = await res.json();
        return data.slice(0, 5).map(n => `<li>${n.title || 'Notifikasi'}</li>`).join('');
      } catch {
        return '<li>Belum ada aktivitas terbaru.</li>';
      }
    }

    async function renderDashboard() {
      const userCount = await fetchUserCount();
      const inventoryCount = await fetchCountGraphQL('/inventory-graphql', '{ getItems { id } }', 'getItems');
      const categoryCount = await fetchCountGraphQL('/category-graphql', '{ getCategories { id } }', 'getCategories');
      const supplierCount = await fetchCountGraphQL('/supplier-graphql', '{ getSuppliers { id } }', 'getSuppliers');
      const notificationCount = await fetchCountGraphQL('/notification-graphql', '{ getNotifications { id } }', 'getNotifications');

      document.getElementById('stats-cards').innerHTML = `
        ${[['User', userCount], ['Inventaris', inventoryCount], ['Kategori', categoryCount], ['Supplier', supplierCount], ['Notifikasi', notificationCount]].map(([label, count]) => `
          <div class='bg-white rounded-xl p-4 shadow-md text-center'>
            <p class='text-blue-600 text-sm'>${label}</p>
            <p class='text-2xl font-bold'>${count}</p>
            <p class='text-sm text-gray-500'>${count > 0 ? 'Tersedia' : 'Belum ada data'}</p>
          </div>
        `).join('')}`;

      new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
          labels: ['User', 'Inventaris', 'Kategori', 'Supplier', 'Notifikasi'],
          datasets: [{
            label: 'Jumlah Data',
            data: [userCount, inventoryCount, categoryCount, supplierCount, notificationCount],
            backgroundColor: ['#3b82f6', '#60a5fa', '#93c5fd', '#7dd3fc', '#fbbf24']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });

      let pieData = [categoryCount];
      let pieLabels = ['Kategori'];
      try {
        const res = await fetch('/category');
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          pieLabels = data.map(c => c.name || 'Kategori');
          pieData = data.map(() => 1);
        }
      } catch {}

      new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
          labels: pieLabels,
          datasets: [{
            data: pieData,
            backgroundColor: ['#3b82f6', '#60a5fa', '#93c5fd', '#7dd3fc', '#fbbf24']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });

      document.getElementById('recent-activity').innerHTML = await fetchRecentActivity();
      document.getElementById('quick-info').innerText = `Terdapat ${userCount} user, ${inventoryCount} inventaris, ${categoryCount} kategori, ${supplierCount} supplier, dan ${notificationCount} notifikasi.`;
    }

    renderDashboard();
  </script>
</body>
</html>